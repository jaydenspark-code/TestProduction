<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéâ FINAL FIX - Braintree Authorization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        #braintree-container {
            margin-top: 20px;
            min-height: 300px;
            border: 3px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            background: linear-gradient(135deg, #f9f9f9, #ffffff);
        }
        .log {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .fix-section {
            background: #e8f5e8;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }
        .comparison > div {
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .wrong { background: #ffebee; border: 1px solid #f44336; }
        .correct { background: #e8f5e8; border: 1px solid #4CAF50; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéâ FINAL FIX - Authorization Issue Resolved!</h1>
        
        <div class="fix-section">
            <h2>üîç Issue Identified</h2>
            <p><strong>Problem:</strong> The client token was being passed as decoded JSON instead of the base64 token.</p>
            <p><strong>Error:</strong> <code>CLIENT_INVALID_AUTHORIZATION</code></p>
            <p><strong>Solution:</strong> Use the raw base64 token from the API response, not the decoded content.</p>
        </div>

        <div class="comparison">
            <div class="wrong">
                <h4>‚ùå WRONG (What we were doing)</h4>
                <div>authorization: "{\"version\":1,\"authorizationFingerprint\":\"eyJ0eXAi..."</div>
                <small>Decoded JSON object as string</small>
            </div>
            <div class="correct">
                <h4>‚úÖ CORRECT (What we need)</h4>
                <div>authorization: "eyJhdXRob3JpemF0aW9uRm..."</div>
                <small>Raw base64 token</small>
            </div>
        </div>
        
        <div id="status" class="status info">
            Ready to test with corrected authorization...
        </div>
        
        <button class="test-button" onclick="testFixedAuthorization()">üöÄ Test FIXED Authorization</button>
        <button class="test-button" onclick="testPaymentMethod()">üí≥ Test Payment Method</button>
        <button class="test-button" onclick="clearLog()">üßπ Clear Log</button>
        
        <div id="log" class="log">Fixed authorization test - logs will appear here...</div>
        
        <div id="braintree-container">
            <h3>üé® Braintree Drop-in Container</h3>
            <p>Click "Test FIXED Authorization" to create Drop-in with properly formatted token!</p>
        </div>
    </div>

    <script type="module">
        // Enhanced logging system
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        
        function addToLog(message, type = 'info', detail = null) {
            const timestamp = new Date().toISOString().substring(11, 23);
            let color = '#f0f0f0';
            let icon = 'üìù';
            
            switch(type) {
                case 'error': color = '#ff6b6b'; icon = '‚ùå'; break;
                case 'success': color = '#4CAF50'; icon = '‚úÖ'; break;
                case 'warning': color = '#ffeb3b'; icon = '‚ö†Ô∏è'; break;
                case 'info': color = '#87CEEB'; icon = 'üí°'; break;
                case 'debug': color = '#DDA0DD'; icon = 'üîç'; break;
            }
            
            let logEntry = `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${icon} ${message}</div>`;
            
            if (detail) {
                logEntry += `<div style="color: #ccc; font-size: 11px; margin-left: 20px; white-space: pre-wrap;">${JSON.stringify(detail, null, 2)}</div>`;
            }
            
            logDiv.innerHTML += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Update main status
            if (type === 'error') {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error detected - check log';
            } else if (type === 'success') {
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Operation successful!';
            }
        }
        
        window.clearLog = function() {
            logDiv.innerHTML = 'Log cleared - ready for fixed authorization test...';
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Ready to test fixed authorization';
        };

        // Global variables
        let dropinModule = null;
        let dropinInstance = null;

        // Import the Drop-in module
        try {
            dropinModule = await import('braintree-web-drop-in');
            addToLog('‚úÖ NPM braintree-web-drop-in imported successfully', 'success');
        } catch (error) {
            addToLog('‚ùå Failed to import braintree-web-drop-in', 'error', error);
        }

        // CORRECTED function to get client token properly
        async function getClientTokenCorrectly() {
            addToLog('üîß Getting client token with CORRECTED parsing...', 'info');
            
            try {
                // Make the API request
                const credentials = btoa('sgfjmfv929kzffsr:4edc8a7489369f8e7d5cb8c9a8066c17');
                const requestBody = `<?xml version="1.0" encoding="UTF-8"?><client-token></client-token>`;
                const apiUrl = 'https://api.sandbox.braintreegateway.com/merchants/2yhrvbtjszdbvxtt/client_token';
                
                addToLog('üì° Making API request...', 'debug');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${credentials}`,
                        'Content-Type': 'application/xml',
                        'Accept': 'application/xml',
                        'Braintree-Version': '2019-01-01'
                    },
                    body: requestBody
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                
                const responseText = await response.text();
                addToLog('üì° Received API response', 'debug');
                
                // Parse XML to get the client token
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(responseText, 'text/xml');
                const clientTokenElement = xmlDoc.querySelector('client-token');
                
                if (!clientTokenElement) {
                    throw new Error('No client token found in response');
                }
                
                // THIS IS THE KEY FIX: Use the raw token, not decoded content
                const rawToken = clientTokenElement.textContent.trim();
                
                addToLog(`‚úÖ Raw token obtained (${rawToken.length} characters)`, 'success');
                addToLog(`üîë Token starts with: ${rawToken.substring(0, 20)}...`, 'debug');
                
                // Verify this is NOT JSON by trying to parse it
                try {
                    JSON.parse(rawToken);
                    addToLog('‚ö†Ô∏è WARNING: Token appears to be JSON, this might be wrong', 'warning');
                } catch (e) {
                    addToLog('‚úÖ Token is NOT JSON - this is correct for authorization', 'success');
                }
                
                // Verify it's base64-ish
                if (rawToken.length > 100 && !rawToken.includes('{')) {
                    addToLog('‚úÖ Token format looks correct for Braintree authorization', 'success');
                } else {
                    addToLog('‚ö†Ô∏è Token format might be incorrect', 'warning');
                }
                
                return rawToken;
                
            } catch (error) {
                addToLog('‚ùå Failed to get client token', 'error', error);
                throw error;
            }
        }

        // Main test function with FIXED authorization
        window.testFixedAuthorization = async function() {
            addToLog('üéâ TESTING WITH FIXED AUTHORIZATION FORMAT!', 'info');
            
            try {
                if (!dropinModule) {
                    throw new Error('Drop-in module not loaded');
                }
                
                // Clear container
                const container = document.getElementById('braintree-container');
                container.innerHTML = '<h3>üîß Creating Drop-in with FIXED authorization...</h3>';
                
                // Get the correctly formatted client token
                const clientToken = await getClientTokenCorrectly();
                
                addToLog('üé® Creating Drop-in with corrected token format...', 'info');
                
                // Configuration with the RAW token (the fix!)
                const dropinConfig = {
                    authorization: clientToken,  // Raw token, not decoded JSON!
                    container: '#braintree-container',
                    card: {
                        cardholderName: {
                            required: false
                        }
                    }
                };
                
                addToLog('üîß Using CORRECTED configuration:', 'debug', {
                    authorizationLength: dropinConfig.authorization.length,
                    authorizationPrefix: dropinConfig.authorization.substring(0, 20) + '...',
                    container: dropinConfig.container,
                    card: dropinConfig.card
                });
                
                // Create Drop-in with fixed authorization
                dropinInstance = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Drop-in creation timed out after 30 seconds'));
                    }, 30000);
                    
                    dropinModule.create(dropinConfig, (createError, instance) => {
                        clearTimeout(timeout);
                        
                        if (createError) {
                            addToLog('‚ùå Drop-in creation failed even with fix', 'error', createError);
                            reject(createError);
                        } else {
                            addToLog('üéâ SUCCESS! Drop-in created with fixed authorization!', 'success');
                            resolve(instance);
                        }
                    });
                });
                
                addToLog('üéä BREAKTHROUGH! Drop-in instance created successfully!', 'success');
                addToLog('üîç Instance methods available:', 'debug', Object.getOwnPropertyNames(Object.getPrototypeOf(dropinInstance)));
                
                // Add success message to container
                const successMsg = document.createElement('div');
                successMsg.innerHTML = `
                    <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 20px; margin: 20px 0; border-radius: 8px; text-align: center;">
                        üéâ <strong>AUTHORIZATION FIXED!</strong> üéâ<br>
                        Drop-in created successfully with proper token format!<br>
                        <small>The issue was using decoded JSON instead of raw base64 token</small>
                    </div>
                `;
                container.appendChild(successMsg);
                
                statusDiv.className = 'status success';
                statusDiv.textContent = 'üéâ FIXED! Drop-in working with correct authorization!';
                
            } catch (error) {
                addToLog('‚ùå Even the fix failed', 'error', error);
                
                // Provide specific error analysis
                if (error.message.includes('CLIENT_INVALID_AUTHORIZATION')) {
                    addToLog('üîç Still getting authorization error - may need to check API credentials', 'warning');
                } else if (error.message.includes('CLIENT_AUTHORIZATION_INVALID')) {
                    addToLog('üîç Authorization invalid - token may be expired or malformed', 'warning');
                } else {
                    addToLog('üîç Different error - progress made but new issue encountered', 'warning');
                }
                
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Fix attempt failed - see log for details';
            }
        };

        // Test payment method
        window.testPaymentMethod = async function() {
            if (!dropinInstance) {
                addToLog('‚ùå Drop-in not initialized. Run "Test FIXED Authorization" first.', 'error');
                return;
            }
            
            addToLog('üí≥ Testing payment method request...', 'info');
            
            try {
                const payload = await new Promise((resolve, reject) => {
                    dropinInstance.requestPaymentMethod((err, result) => {
                        if (err) {
                            reject(err);
                        } else {
                            resolve(result);
                        }
                    });
                });
                
                addToLog('‚úÖ Payment method obtained successfully!', 'success');
                addToLog('Payment method details:', 'info', {
                    type: payload.type,
                    nonce: payload.nonce ? 'Present' : 'Missing',
                    details: payload.details ? 'Present' : 'Missing'
                });
                
                alert('‚úÖ Payment method test successful! Drop-in is fully working!');
                
            } catch (error) {
                addToLog('‚ùå Payment method request failed', 'error', error);
            }
        };

        // Initial setup
        addToLog('üîß Authorization fix test loaded', 'info');
        addToLog('üí° Key insight: Use raw base64 token, not decoded JSON object', 'info');
        addToLog('üöÄ Click "Test FIXED Authorization" to verify the fix!', 'info');
    </script>
</body>
</html>
