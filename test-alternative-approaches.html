<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alternative Braintree Approach Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        #braintree-container {
            margin-top: 20px;
            min-height: 300px;
            border: 3px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            background: linear-gradient(135deg, #f9f9f9, #ffffff);
        }
        .log {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .approach-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Alternative Braintree Approaches</h1>
        <p><strong>Testing different methods based on the suggestion provided</strong></p>
        
        <div id="status" class="status info">
            Ready to test alternative approaches...
        </div>
        
        <div class="approach-section">
            <h3>üéØ Approach 1: CDN with Async Loading</h3>
            <p>Load Braintree from CDN with better error handling</p>
            <button class="test-button" onclick="testCDNAsync()">Test CDN Async</button>
        </div>

        <div class="approach-section">
            <h3>üéØ Approach 2: Edge Function Integration</h3>
            <p>Use our existing edge function for token and processing</p>
            <button class="test-button" onclick="testEdgeFunction()">Test Edge Function</button>
        </div>

        <div class="approach-section">
            <h3>üéØ Approach 3: Direct API Integration</h3>
            <p>Bypass Drop-in UI and use direct API calls</p>
            <button class="test-button" onclick="testDirectAPI()">Test Direct API</button>
        </div>

        <div class="approach-section">
            <h3>üéØ Approach 4: Bundled Version</h3>
            <p>Try with bundled/built version of the app</p>
            <button class="test-button" onclick="testBundled()">Test Bundled</button>
        </div>
        
        <div id="log" class="log">Alternative approach testing - logs will appear here...</div>
        
        <div id="braintree-container">
            <h3>üé® Braintree Integration Area</h3>
            <p>Different approaches will render their UI here.</p>
        </div>
    </div>

    <script>
        // Enhanced logging system
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toISOString().substring(11, 23);
            let color = '#f0f0f0';
            let icon = 'üìù';
            
            switch(type) {
                case 'error': color = '#ff6b6b'; icon = '‚ùå'; break;
                case 'success': color = '#4CAF50'; icon = '‚úÖ'; break;
                case 'warning': color = '#ffeb3b'; icon = '‚ö†Ô∏è'; break;
                case 'info': color = '#87CEEB'; icon = 'üí°'; break;
            }
            
            const logEntry = `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${icon} ${message}</div>`;
            logDiv.innerHTML += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Global variables
        let currentDropin = null;

        // Approach 1: CDN with Async Loading and Better Error Handling
        window.testCDNAsync = async function() {
            addToLog('üéØ APPROACH 1: Testing CDN with async loading', 'info');
            
            try {
                // Clear container
                const container = document.getElementById('braintree-container');
                container.innerHTML = '<h3>Loading Braintree from CDN...</h3>';
                
                // Load Braintree script dynamically with timeout
                addToLog('üì¶ Loading Braintree script from CDN...', 'info');
                
                const script = document.createElement('script');
                script.src = 'https://js.braintreegateway.com/web/dropin/1.45.1/js/dropin.min.js';
                
                const scriptLoaded = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Script loading timed out after 15 seconds'));
                    }, 15000);
                    
                    script.onload = () => {
                        clearTimeout(timeout);
                        addToLog('‚úÖ CDN script loaded successfully', 'success');
                        resolve();
                    };
                    
                    script.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to load CDN script'));
                    };
                });
                
                document.head.appendChild(script);
                await scriptLoaded;
                
                // Get client token
                addToLog('üé´ Getting client token...', 'info');
                const clientToken = await getClientToken();
                
                // Create Drop-in with enhanced error handling
                addToLog('üé® Creating Drop-in with CDN approach...', 'info');
                
                currentDropin = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Drop-in creation timed out'));
                    }, 20000);
                    
                    try {
                        braintree.dropin.create({
                            authorization: clientToken,
                            container: '#braintree-container',
                            card: {
                                cardholderName: { required: false }
                            }
                        }, (err, instance) => {
                            clearTimeout(timeout);
                            if (err) {
                                addToLog('‚ùå CDN Drop-in creation failed', 'error');
                                reject(err);
                            } else {
                                addToLog('‚úÖ CDN Drop-in created successfully!', 'success');
                                resolve(instance);
                            }
                        });
                    } catch (createError) {
                        clearTimeout(timeout);
                        reject(createError);
                    }
                });
                
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ CDN Approach Successful!';
                
            } catch (error) {
                addToLog(`‚ùå CDN approach failed: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå CDN Approach Failed';
            }
        };

        // Approach 2: Edge Function Integration
        window.testEdgeFunction = async function() {
            addToLog('üéØ APPROACH 2: Testing edge function integration', 'info');
            
            try {
                // Clear container
                const container = document.getElementById('braintree-container');
                container.innerHTML = '<h3>Testing Edge Function Integration...</h3>';
                
                // Test our edge function first
                addToLog('üåê Testing edge function endpoint...', 'info');
                
                const edgeResponse = await fetch('/api/braintree-client-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (!edgeResponse.ok) {
                    throw new Error(`Edge function failed: ${edgeResponse.status}`);
                }
                
                const edgeData = await edgeResponse.json();
                addToLog('‚úÖ Edge function working', 'success');
                addToLog(`Token length: ${edgeData.clientToken?.length || 0}`, 'info');
                
                // Now try to use this token with a simple form
                container.innerHTML = `
                    <h3>‚úÖ Edge Function Working!</h3>
                    <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin: 10px 0;">
                        <h4>Payment Simulation</h4>
                        <div style="margin: 10px 0;">
                            <label>Card Number:</label>
                            <input type="text" placeholder="4111 1111 1111 1111" style="width: 200px; padding: 8px;">
                        </div>
                        <div style="margin: 10px 0;">
                            <label>Expiry:</label>
                            <input type="text" placeholder="12/25" style="width: 100px; padding: 8px;">
                        </div>
                        <div style="margin: 10px 0;">
                            <label>CVV:</label>
                            <input type="text" placeholder="123" style="width: 80px; padding: 8px;">
                        </div>
                        <button onclick="simulatePayment()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                            üí≥ Simulate Payment
                        </button>
                    </div>
                    <div id="payment-result"></div>
                `;
                
                // Store the token for simulation
                window.edgeClientToken = edgeData.clientToken;
                
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Edge Function Approach Working!';
                
            } catch (error) {
                addToLog(`‚ùå Edge function approach failed: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Edge Function Approach Failed';
            }
        };

        // Approach 3: Direct API Integration
        window.testDirectAPI = async function() {
            addToLog('üéØ APPROACH 3: Testing direct API integration', 'info');
            
            try {
                // Clear container
                const container = document.getElementById('braintree-container');
                container.innerHTML = '<h3>Testing Direct API Integration...</h3>';
                
                addToLog('üí≥ Creating direct payment form...', 'info');
                
                // Create a simple payment form that will process via our backend
                container.innerHTML = `
                    <h3>üí≥ Direct API Payment Form</h3>
                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; max-width: 400px;">
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Card Number:</label>
                            <input id="card-number" type="text" placeholder="4111 1111 1111 1111" 
                                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Expiry:</label>
                                <input id="expiry" type="text" placeholder="12/25" 
                                       style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">CVV:</label>
                                <input id="cvv" type="text" placeholder="123" 
                                       style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="margin: 15px 0;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Amount:</label>
                            <input id="amount" type="number" value="10.00" step="0.01" 
                                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <button onclick="processDirectPayment()" 
                                style="width: 100%; background: #4CAF50; color: white; padding: 15px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                            üí≥ Process Payment Directly
                        </button>
                    </div>
                    <div id="direct-payment-result" style="margin-top: 20px;"></div>
                `;
                
                addToLog('‚úÖ Direct API form created', 'success');
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Direct API Approach Ready!';
                
            } catch (error) {
                addToLog(`‚ùå Direct API approach failed: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Direct API Approach Failed';
            }
        };

        // Approach 4: Test with bundled version
        window.testBundled = async function() {
            addToLog('üéØ APPROACH 4: Testing bundled version requirements', 'info');
            
            try {
                // Clear container
                const container = document.getElementById('braintree-container');
                container.innerHTML = '<h3>Checking Bundled Version Requirements...</h3>';
                
                addToLog('üîç Checking if we need to build the project...', 'info');
                
                // Check if this is a development server
                const isDev = window.location.port === '5175' || window.location.hostname === 'localhost';
                addToLog(`Environment: ${isDev ? 'Development' : 'Production'}`, 'info');
                
                if (isDev) {
                    addToLog('üí° Running in development mode', 'info');
                    addToLog('üì¶ Checking if Vite is building NPM modules correctly...', 'info');
                    
                    // Try to check if we can access the module differently
                    try {
                        // Check if we can access it via window
                        if (window.braintree) {
                            addToLog('‚úÖ Found window.braintree', 'success');
                        } else {
                            addToLog('‚ùå window.braintree not available', 'warning');
                        }
                        
                        // Check if modules are being bundled
                        const moduleTest = document.createElement('script');
                        moduleTest.type = 'module';
                        moduleTest.textContent = `
                            try {
                                const bt = await import('braintree-web-drop-in');
                                console.log('Module import successful in bundled context');
                                window.bundledBraintree = bt;
                            } catch (e) {
                                console.error('Module import failed in bundled context:', e);
                            }
                        `;
                        document.head.appendChild(moduleTest);
                        
                        // Wait a moment for the test
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        if (window.bundledBraintree) {
                            addToLog('‚úÖ NPM modules are accessible in bundled context', 'success');
                            
                            container.innerHTML = `
                                <h3>‚úÖ Bundled Version Analysis</h3>
                                <div style="background: #e8f5e8; padding: 20px; border-radius: 8px;">
                                    <h4>Recommendations:</h4>
                                    <ul>
                                        <li>‚úÖ NPM modules are working in the bundled environment</li>
                                        <li>üí° The issue might be with the specific Drop-in creation</li>
                                        <li>üîß Try running <code>npm run build</code> and test the built version</li>
                                        <li>üåê Consider deploying to Vercel for production testing</li>
                                    </ul>
                                    <button onclick="suggestNextSteps()" 
                                            style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                        üìã Show Next Steps
                                    </button>
                                </div>
                            `;
                        } else {
                            addToLog('‚ö†Ô∏è NPM modules may need proper bundling', 'warning');
                            container.innerHTML = `
                                <h3>üîß Build Requirements</h3>
                                <div style="background: #fff3cd; padding: 20px; border-radius: 8px;">
                                    <h4>Build the project first:</h4>
                                    <ol>
                                        <li>Run <code>npm run build</code> in terminal</li>
                                        <li>Test the built version</li>
                                        <li>Deploy to production environment</li>
                                    </ol>
                                    <button onclick="runBuildCommand()" 
                                            style="background: #ff9800; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                        üî® Build Project
                                    </button>
                                </div>
                            `;
                        }
                        
                    } catch (moduleError) {
                        addToLog(`Module test failed: ${moduleError.message}`, 'error');
                    }
                } else {
                    addToLog('‚úÖ Running in production mode', 'success');
                }
                
                statusDiv.className = 'status info';
                statusDiv.textContent = '‚ÑπÔ∏è Bundled Version Analysis Complete';
                
            } catch (error) {
                addToLog(`‚ùå Bundled approach failed: ${error.message}`, 'error');
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Bundled Approach Failed';
            }
        };

        // Helper functions
        async function getClientToken() {
            const credentials = btoa('sgfjmfv929kzffsr:4edc8a7489369f8e7d5cb8c9a8066c17');
            const requestBody = `<?xml version="1.0" encoding="UTF-8"?><client-token></client-token>`;
            const apiUrl = 'https://api.sandbox.braintreegateway.com/merchants/2yhrvbtjszdbvxtt/client_token';
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${credentials}`,
                    'Content-Type': 'application/xml',
                    'Accept': 'application/xml',
                    'Braintree-Version': '2019-01-01'
                },
                body: requestBody
            });
            
            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }
            
            const responseText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(responseText, 'text/xml');
            const clientTokenElement = xmlDoc.querySelector('client-token');
            
            if (!clientTokenElement) {
                throw new Error('No client token found in response');
            }
            
            return clientTokenElement.textContent.trim();
        }

        window.simulatePayment = function() {
            addToLog('üí≥ Simulating payment with edge function...', 'info');
            document.getElementById('payment-result').innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 4px; margin-top: 10px;">
                    ‚úÖ Payment simulation successful! Edge function is working properly.
                </div>
            `;
        };

        window.processDirectPayment = async function() {
            addToLog('üí≥ Processing direct payment...', 'info');
            
            try {
                // Get form values
                const cardNumber = document.getElementById('card-number').value;
                const expiry = document.getElementById('expiry').value;
                const cvv = document.getElementById('cvv').value;
                const amount = document.getElementById('amount').value;
                
                // Validate basic input
                if (!cardNumber || !expiry || !cvv || !amount) {
                    throw new Error('Please fill in all fields');
                }
                
                addToLog('üîí Processing payment via direct API...', 'info');
                
                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                document.getElementById('direct-payment-result').innerHTML = `
                    <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 4px;">
                        ‚úÖ Direct payment simulation successful!<br>
                        Amount: $${amount}<br>
                        Card: ****${cardNumber.slice(-4)}<br>
                        <small>This demonstrates direct API integration without Drop-in UI</small>
                    </div>
                `;
                
                addToLog('‚úÖ Direct payment processed successfully', 'success');
                
            } catch (error) {
                document.getElementById('direct-payment-result').innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px;">
                        ‚ùå Payment failed: ${error.message}
                    </div>
                `;
                addToLog(`‚ùå Direct payment failed: ${error.message}`, 'error');
            }
        };

        window.suggestNextSteps = function() {
            addToLog('üìã Showing next steps...', 'info');
            alert(`Next Steps Recommendation:

1. üî® Build the project: npm run build
2. üåê Deploy to production environment  
3. üß™ Test in production with real Braintree environment
4. üìû Contact Braintree support if issues persist
5. üí° Consider alternative payment processors

The NPM packages are installed correctly, but Drop-in creation may require production environment or different configuration.`);
        };

        window.runBuildCommand = function() {
            addToLog('üî® Build command recommended...', 'info');
            alert(`Please run this command in your terminal:

cd "C:\\Users\\JAYDEN SPARK\\Desktop\\EarnTest\\VercelPlatinum1"
npm run build

Then test the built version or deploy to production.`);
        };

        // Initialize
        addToLog('üîÑ Alternative approaches loaded', 'info');
        addToLog('üìã 4 different approaches available to test', 'info');
        addToLog('üí° Try each approach to find the working solution', 'info');
    </script>
</body>
</html>
