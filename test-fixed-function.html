<!DOCTYPE html>
<html>
<head>
    <title>Test Fixed Edge Function</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Test Fixed Email Verification Function</h1>
    
    <div class="status info">
        <strong>‚úÖ Fixed Issues:</strong>
        <ul>
            <li>Removed duplicate token declaration</li>
            <li>Function deployed with --no-verify-jwt flag</li>
            <li>No authentication barriers</li>
        </ul>
    </div>

    <div class="status warning">
        <strong>üöÄ Testing Function:</strong>
        <br>URL: <a href="https://bmtaqilpuszwoshtizmq.supabase.co/functions/v1/verify-email?token=test" target="_blank">
            https://bmtaqilpuszwoshtizmq.supabase.co/functions/v1/verify-email?token=test
        </a>
    </div>

    <button class="btn" onclick="testFunction()">üß™ Test Function Now</button>
    <button class="btn" onclick="showFinalURL()">üìß Show Final Email URL Template</button>

    <div id="results" style="margin-top: 20px;"></div>

    <script>
        function testFunction() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">üîÑ Testing function...</div>';

            fetch('https://bmtaqilpuszwoshtizmq.supabase.co/functions/v1/verify-email?token=test')
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);
                    
                    if (response.status === 200) {
                        return response.text().then(text => ({
                            status: response.status,
                            isHTML: text.includes('<html>'),
                            text: text
                        }));
                    } else {
                        return response.text().then(text => ({
                            status: response.status,
                            text: text
                        }));
                    }
                })
                .then(data => {
                    if (data.status === 200 && data.isHTML) {
                        resultsDiv.innerHTML = `
                            <div class="status success">
                                <strong>üéâ SUCCESS!</strong>
                                <p>Function is working! Returned HTML verification page (Status: ${data.status})</p>
                                <p>‚úÖ No more WORKER_ERROR</p>
                                <p>‚úÖ Function processes requests correctly</p>
                                <p>‚úÖ Ready for SendGrid email integration!</p>
                            </div>
                        `;
                    } else {
                        resultsDiv.innerHTML = `
                            <div class="status error">
                                <strong>‚ùå Still Issues</strong>
                                <p>Status: ${data.status}</p>
                                <pre>${data.text}</pre>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Test error:', error);
                    resultsDiv.innerHTML = `
                        <div class="status error">
                            <strong>‚ùå Network Error</strong>
                            <pre>${error.message}</pre>
                        </div>
                    `;
                });
        }

        function showFinalURL() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="status success">
                    <strong>üìß Final SendGrid Email Template URL:</strong>
                    <br><br>
                    <code>https://bmtaqilpuszwoshtizmq.supabase.co/functions/v1/verify-email?token={{verification_token}}</code>
                    <br><br>
                    <strong>No headers required!</strong>
                    <br>‚úÖ Works directly from email links
                    <br>‚úÖ No authentication needed
                    <br>‚úÖ Redirects to payment page after verification
                </div>
            `;
        }
    </script>
</body>
</html>
